(function(a){elFinder.prototype.eventsManager=function(d,c){var b=this;this.lock=false;this.fm=d;this.ui=d.ui;this.tree=d.view.tree;this.cwd=d.view.cwd;this.pointer="";this.init=function(){var f=this,g=false;f.lock=false;this.cwd.bind("click",function(i){var h=a(i.target);if(h.hasClass("ui-selected")){f.fm.unselectAll()}else{if(!h.attr("key")){h=h.parent("[key]")}if(i.ctrlKey||i.metaKey){f.fm.toggleSelect(h)}else{f.fm.select(h,true)}}}).bind(window.opera?"click":"contextmenu",function(i){if(window.opera&&!i.ctrlKey){return}i.preventDefault();i.stopPropagation();var h=a(i.target);if(a.browser.mozilla){g=true}if(h.hasClass("el-finder-cwd")){f.fm.unselectAll()}else{f.fm.select(h.attr("key")?h:h.parent("[key]"))}f.fm.quickLook.hide();f.fm.ui.showMenu(i)}).selectable({filter:"[key]",delay:300,stop:function(){f.fm.updateSelect();f.fm.log("mouseup")}});a(document).bind("click",function(h){!g&&f.fm.ui.hideMenu();g=false;a("input",f.cwd).trigger("change");if(!a(h.target).is("input,textarea,select")){a("input,textarea").blur()}});a("input,textarea").live("focus",function(h){f.lock=true}).live("blur",function(h){f.lock=false});this.tree.bind("select",function(h){f.tree.find("a").removeClass("selected");a(h.target).addClass("selected").parents("li:has(ul)").children("ul").show().prev().children("div").addClass("expanded")});if(this.fm.options.places){this.fm.view.plc.click(function(l){l.preventDefault();var j=a(l.target),k=j.attr("key"),i;if(k){k!=f.fm.cwd.hash&&f.ui.exec("open",l.target)}else{if(l.target.nodeName=="A"||l.target.nodeName=="DIV"){i=f.fm.view.plc.find("ul");if(i.children().length){i.toggle(300);f.fm.view.plc.children("li").find("div").toggleClass("expanded")}}}});this.fm.view.plc.droppable({accept:"(div,tr).directory",tolerance:"pointer",over:function(){a(this).addClass("el-finder-droppable")},out:function(){a(this).removeClass("el-finder-droppable")},drop:function(j,i){a(this).removeClass("el-finder-droppable");var h=false;i.helper.children(".directory:not(.noaccess,.dropbox)").each(function(){if(f.fm.addPlace(a(this).attr("key"))){h=true;a(this).hide()}});if(h){f.fm.view.renderPlaces();f.updatePlaces();f.fm.view.plc.children("li").children("div").trigger("click")}if(!i.helper.children("div:visible").length){i.helper.hide()}}})}a(document).bind(a.browser.mozilla||a.browser.opera?"keypress":"keydown",function(i){var h=i.ctrlKey||i.metaKey;if(f.lock){return}switch(i.keyCode){case 37:case 38:i.stopPropagation();i.preventDefault();if(i.keyCode==37&&h){f.ui.execIfAllowed("back")}else{e(false,!i.shiftKey)}break;case 39:case 40:i.stopPropagation();i.preventDefault();if(h){f.ui.execIfAllowed("open")}else{e(true,!i.shiftKey)}break}});a(document).bind(a.browser.opera?"keypress":"keydown",function(h){if(f.lock){return}switch(h.keyCode){case 32:h.preventDefault();h.stopPropagation();f.fm.quickLook.toggle();break;case 27:f.fm.quickLook.hide();break}});if(!this.fm.options.disableShortcuts){a(document).bind("keydown",function(i){var h=i.ctrlKey||i.metaKey;if(f.lock){return}switch(i.keyCode){case 8:if(h&&f.ui.isCmdAllowed("rm")){i.preventDefault();f.ui.exec("rm")}break;case 13:if(f.ui.isCmdAllowed("select")){return f.ui.exec("select")}f.ui.execIfAllowed("open");break;case 46:f.ui.execIfAllowed("rm");break;case 65:if(h){i.preventDefault();f.fm.selectAll()}break;case 67:h&&f.ui.execIfAllowed("copy");break;case 73:if(h){i.preventDefault();f.ui.exec("info")}break;case 78:if(h){i.preventDefault();f.ui.execIfAllowed("mkdir")}break;case 85:if(h){i.preventDefault();f.ui.execIfAllowed("upload")}break;case 86:h&&f.ui.execIfAllowed("paste");break;case 88:h&&f.ui.execIfAllowed("cut");break;case 113:f.ui.execIfAllowed("rename");break}})}};this.updateNav=function(){a("a",this.tree).click(function(g){g.preventDefault();var f=a(this),h;if(g.target.nodeName=="DIV"&&a(g.target).hasClass("collapsed")){a(g.target).toggleClass("expanded").parent().next("ul").toggle(300)}else{if(f.attr("key")!=b.fm.cwd.hash){if(f.hasClass("noaccess")||f.hasClass("dropbox")){b.fm.view.error("Access denied")}else{b.ui.exec("open",f.trigger("select")[0])}}else{h=f.children(".collapsed");if(h.length){h.toggleClass("expanded");f.next("ul").toggle(300)}}}});a("a:not(.noaccess,.readonly)",this.tree).droppable({tolerance:"pointer",accept:"div[key],tr[key]",over:function(){a(this).addClass("el-finder-droppable")},out:function(){a(this).removeClass("el-finder-droppable")},drop:function(g,f){a(this).removeClass("el-finder-droppable");b.fm.drop(g,f,a(this).attr("key"))}});this.fm.options.places&&this.updatePlaces()};this.updatePlaces=function(){this.fm.view.plc.children("li").find("li").draggable({scroll:false,stop:function(){if(b.fm.removePlace(a(this).children("a").attr("key"))){a(this).remove();if(!a("li",b.fm.view.plc.children("li")).length){b.fm.view.plc.children("li").find("div").removeClass("collapsed expanded").end().children("ul").hide()}}}})};this.updateCwd=function(){a("[key]",this.cwd).bind("dblclick",function(f){b.fm.select(a(this),true);b.ui.exec(b.ui.isCmdAllowed("select")?"select":"open")}).draggable({delay:3,addClasses:false,appendTo:".el-finder-cwd",revert:true,drag:function(g,f){f.helper.toggleClass("el-finder-drag-copy",g.shiftKey||g.ctrlKey)},helper:function(){var f=a(this),g=a('<div class="el-finder-drag-helper"/>'),i=0;!f.hasClass("ui-selected")&&b.fm.select(f,true);b.cwd.find(".ui-selected").each(function(h){var j=b.fm.options.view=="icons"?a(this).clone().removeClass("ui-selected"):a(b.fm.view.renderIcon(b.fm.cdc[a(this).attr("key")]));if(i++==0||i%12==0){j.css("margin-left",0)}g.append(j)});return g.css("width",(i<=12?85+(i-1)*29:387)+"px")}}).filter(".directory").droppable({tolerance:"pointer",accept:"div[key],tr[key]",over:function(){a(this).addClass("el-finder-droppable")},out:function(){a(this).removeClass("el-finder-droppable")},drop:function(g,f){a(this).removeClass("el-finder-droppable");b.fm.drop(g,f,a(this).attr("key"))}});if(a.browser.msie){a("*",this.cwd).attr("unselectable","on").filter("[key]").bind("dragstart",function(){b.cwd.selectable("disable").removeClass("ui-state-disabled ui-selectable-disabled")}).bind("dragstop",function(){b.cwd.selectable("enable")})}};function e(g,h){var i,f,j;if(!a("[key]",b.cwd).length){return}if(b.fm.selected.length==0){i=a("[key]:"+(g?"first":"last"),b.cwd);b.fm.select(i)}else{if(h){i=a(".ui-selected:"+(g?"last":"first"),b.cwd);f=i[g?"next":"prev"]("[key]");if(f.length){i=f}b.fm.select(i,true)}else{if(b.pointer){j=a('[key="'+b.pointer+'"].ui-selected',b.cwd)}if(!j||!j.length){j=a(".ui-selected:"+(g?"last":"first"),b.cwd)}i=j[g?"next":"prev"]("[key]");if(!i.length){i=j}else{if(!i.hasClass("ui-selected")){b.fm.select(i)}else{if(!j.hasClass("ui-selected")){b.fm.unselect(i)}else{f=j[g?"prev":"next"]("[key]");if(!f.length||!f.hasClass("ui-selected")){b.fm.unselect(j)}else{while((f=g?i.next("[key]"):i.prev("[key]"))&&i.hasClass("ui-selected")){i=f}b.fm.select(i)}}}}}}b.pointer=i.attr("key");b.fm.checkSelectedPos(g)}}})(jQuery);