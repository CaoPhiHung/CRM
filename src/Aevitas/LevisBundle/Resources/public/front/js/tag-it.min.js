(function(a){a.widget("ui.tagit",{options:{allowDuplicates:!1,caseSensitive:!0,fieldName:"tags",placeholderText:null,readOnly:!1,removeConfirmation:!1,tagLimit:null,availableTags:[],autocomplete:{},showAutocompleteOnFocus:!1,allowSpaces:!1,singleField:!1,singleFieldDelimiter:",",singleFieldNode:null,animate:!0,tabIndex:null,beforeTagAdded:null,afterTagAdded:null,beforeTagRemoved:null,afterTagRemoved:null,onTagClicked:null,onTagLimitExceeded:null,onTagAdded:null,onTagRemoved:null,tagSource:null},_create:function(){var b=this;this.element.is("input")?(this.tagList=a("<ul></ul>").insertAfter(this.element),this.options.singleField=!0,this.options.singleFieldNode=this.element,this.element.css("display","none")):this.tagList=this.element.find("ul, ol").andSelf().last();this.tagInput=a('<input type="text" />').addClass("ui-widget-content");this.options.readOnly&&this.tagInput.attr("disabled","disabled");this.options.tabIndex&&this.tagInput.attr("tabindex",this.options.tabIndex);this.options.placeholderText&&this.tagInput.attr("placeholder",this.options.placeholderText);this.options.autocomplete.source||(this.options.autocomplete.source=function(i,l){var k=i.term.toLowerCase(),j=a.grep(this.options.availableTags,function(c){return 0===c.toLowerCase().indexOf(k)});l(this._subtractArray(j,this.assignedTags()))});this.options.showAutocompleteOnFocus&&(this.tagInput.focus(function(){b._showAutocomplete()}),"undefined"===typeof this.options.autocomplete.minLength&&(this.options.autocomplete.minLength=0));a.isFunction(this.options.autocomplete.source)&&(this.options.autocomplete.source=a.proxy(this.options.autocomplete.source,this));a.isFunction(this.options.tagSource)&&(this.options.tagSource=a.proxy(this.options.tagSource,this));this.tagList.addClass("tagit").addClass("ui-widget ui-widget-content ui-corner-all").append(a('<li class="tagit-new"></li>').append(this.tagInput)).click(function(i){var e=a(i.target);e.hasClass("tagit-label")?(e=e.closest(".tagit-choice"),e.hasClass("removed")||b._trigger("onTagClicked",i,{tag:e,tagLabel:b.tagLabel(e)})):b.tagInput.focus()});var g=!1;if(this.options.singleField){if(this.options.singleFieldNode){var h=a(this.options.singleFieldNode),f=h.val().split(this.options.singleFieldDelimiter);h.val("");a.each(f,function(d,e){b.createTag(e,null,!0);g=!0})}else{this.options.singleFieldNode=a('<input type="hidden" style="display:none;" value="" name="'+this.options.fieldName+'" />'),this.tagList.after(this.options.singleFieldNode)}}g||this.tagList.children("li").each(function(){a(this).hasClass("tagit-new")||(b.createTag(a(this).text(),a(this).attr("class"),!0),a(this).remove())});this.tagInput.keydown(function(i){if(i.which==a.ui.keyCode.BACKSPACE&&""===b.tagInput.val()){var e=b._lastTag();!b.options.removeConfirmation||e.hasClass("remove")?b.removeTag(e):b.options.removeConfirmation&&e.addClass("remove ui-state-highlight")}else{b.options.removeConfirmation&&b._lastTag().removeClass("remove ui-state-highlight")}if(i.which===a.ui.keyCode.COMMA||i.which===a.ui.keyCode.ENTER||i.which==a.ui.keyCode.TAB&&""!==b.tagInput.val()){i.which===a.ui.keyCode.ENTER&&""===b.tagInput.val()||i.preventDefault(),b.createTag(b._cleanedInput()),b.tagInput.autocomplete("close")}}).blur(function(){b.tagInput.data("autocomplete-open")||b.createTag(b._cleanedInput())});if(this.options.availableTags||this.options.tagSource||this.options.autocomplete.source){h={select:function(d,e){b.createTag(e.item.value);return !1}},a.extend(h,this.options.autocomplete),h.source=this.options.tagSource||h.source,this.tagInput.autocomplete(h).bind("autocompleteopen",function(){b.tagInput.data("autocomplete-open",!0)}).bind("autocompleteclose",function(){b.tagInput.data("autocomplete-open",!1)})}},_cleanedInput:function(){return a.trim(this.tagInput.val().replace(/^"(.*)"$/,"$1"))},_lastTag:function(){return this.tagList.find(".tagit-choice:last:not(.removed)")},_tags:function(){return this.tagList.find(".tagit-choice:not(.removed)")},assignedTags:function(){var b=this,c=[];this.options.singleField?(c=a(this.options.singleFieldNode).val().split(this.options.singleFieldDelimiter),""===c[0]&&(c=[])):this._tags().each(function(){c.push(b.tagLabel(this))});return c},_updateSingleTagsField:function(b){a(this.options.singleFieldNode).val(b.join(this.options.singleFieldDelimiter)).trigger("change")},_subtractArray:function(b,g){for(var h=[],f=0;f<b.length;f++){-1==a.inArray(b[f],g)&&h.push(b[f])}return h},tagLabel:function(b){return this.options.singleField?a(b).find(".tagit-label:first").text():a(b).find("input:first").val()},_showAutocomplete:function(){this.tagInput.autocomplete("search","")},_findTagByLabel:function(b){var e=this,f=null;this._tags().each(function(){if(e._formatStr(b)==e._formatStr(e.tagLabel(this))){return f=a(this),!1}});return f},_isNew:function(b){return !this._findTagByLabel(b)},_formatStr:function(b){return this.options.caseSensitive?b:a.trim(b.toLowerCase())},_effectExists:function(b){return Boolean(a.effects&&(a.effects[b]||a.effects.effect&&a.effects.effect[b]))},createTag:function(b,k,l){var j=this;b=a.trim(b);if(""===b){return !1}if(!this.options.allowDuplicates&&!this._isNew(b)){return b=this._findTagByLabel(b),!1!==this._trigger("onTagExists",null,{existingTag:b,duringInitialization:l})&&this._effectExists("highlight")&&b.effect("highlight"),!1}if(this.options.tagLimit&&this._tags().length>=this.options.tagLimit){return this._trigger("onTagLimitExceeded",null,{duringInitialization:l}),!1}var h=a(this.options.onTagClicked?'<a class="tagit-label"></a>':'<span class="tagit-label"></span>').text(b),i=a("<li></li>").addClass("tagit-choice ui-widget-content ui-state-default ui-corner-all").addClass(k).append(h);this.options.readOnly?i.addClass("tagit-choice-read-only"):(i.addClass("tagit-choice-editable"),k=a("<span></span>").addClass("ui-icon ui-icon-close"),k=a('<a><span class="text-icon">\u00d7</span></a>').addClass("tagit-close").append(k).click(function(){j.removeTag(i)}),i.append(k));this.options.singleField||(h=h.html(),i.append('<input type="hidden" style="display:none;" value="'+h+'" name="'+this.options.fieldName+'" />'));!1!==this._trigger("beforeTagAdded",null,{tag:i,tagLabel:this.tagLabel(i),duringInitialization:l})&&(this.options.singleField&&(h=this.assignedTags(),h.push(b),this._updateSingleTagsField(h)),this._trigger("onTagAdded",null,i),this.tagInput.val(""),this.tagInput.parent().before(i),this._trigger("afterTagAdded",null,{tag:i,tagLabel:this.tagLabel(i),duringInitialization:l}),this.options.showAutocompleteOnFocus&&!l&&setTimeout(function(){j._showAutocomplete()},0))},removeTag:function(b,g){g="undefined"===typeof g?this.options.animate:g;b=a(b);this._trigger("onTagRemoved",null,b);if(!1!==this._trigger("beforeTagRemoved",null,{tag:b,tagLabel:this.tagLabel(b)})){if(this.options.singleField){var h=this.assignedTags(),f=this.tagLabel(b),h=a.grep(h,function(c){return c!=f});this._updateSingleTagsField(h)}g?(b.addClass("removed"),h=this._effectExists("blind")?["blind",{direction:"horizontal"},"fast"]:["fast"],h.push(function(){b.remove()}),b.fadeOut("fast").hide.apply(b,h).dequeue()):b.remove();this._trigger("afterTagRemoved",null,{tag:b,tagLabel:this.tagLabel(b)})}},removeTagByLabel:function(e,d){var f=this._findTagByLabel(e);if(!f){throw"No such tag exists with the name '"+e+"'"}this.removeTag(f,d)},removeAll:function(){var b=this;this._tags().each(function(d,e){b.removeTag(e,!1)})}})})(jQuery);